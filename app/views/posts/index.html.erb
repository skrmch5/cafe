
<br>
<br>
<br>

<h3>検索</h3>
<%= form_tag({controller:"posts",action:"index"}, method: :get) do %>
  <%= text_field_tag :search %>
  <%= submit_tag '検索する'  %>
<% end %>
<h3>投稿一覧</h3>
<%= page_entries_info @posts %>
<div class="posts-container">
  <% @posts.each do |t| %>
    <div class="post">
      <%= t.user.email %>
      <br>
      <%= t.body %>
      <br>
      <span class="star-rating">
        <span class="star-rating-front" style="width: <%= getPercent(t.level) %>%;">★★★★★</span>
        <span class="star-rating-back">★★★★★</span>
      </span>
      <br>
      <% t.tags.each do |tag| %>
        <%= tag.name %>
      <% end %>
      <br>
      <%= image_tag t.image_url, size: "250x200" if t.image? %>
      <br>
      <%= t.created_at %>
      <% if user_signed_in? %>
        <% if current_user.already_liked?(t) %>
          <%= button_to post_like_path(id: t.id, post_id: t.id), method: :delete do %>
            <i class="fas fa-heart"></i><%= t.likes.count %>
          <% end %>
        <% else %>
          <%= button_to post_likes_path(id: t.id, post_id: t.id), method: :post do %>
            <i class="fas fa-heart"></i><%= t.likes.count %>
          <% end %>
        <% end %>
      <% else %>
        <i class="fas fa-heart"></i><%= t.likes.count %>
      <% end %>
      <%= link_to "詳細へ", post_path(t.id) %>
    </div>
  <% end %>
</div>
<h3>Google Map</h3>
<div id='map'></div>
<style>
  #map {
    height: 600px;
    width: 100%;
  }
</style>
<!-- js部分 -->
<script>
  function initMap() {

    //初期表示位置
    let latlng = new google.maps.LatLng(38.60, 139.5);
    //デザイン
    let styles = [
         {
          stylers: [
           { "saturation": 0 },
           { "lightness": 0 }
          ]
         }
        ];

    let map = new google.maps.Map(document.getElementById('map'), {
        zoom: 5.5,
        styles: styles,
        center: latlng
    });
    let transitLayer = new google.maps.TransitLayer();
    transitLayer.setMap(map);

  //複数マーカー ここから
    <% @posts.each do |post|%>
      ( function() {
        let markerLatLng = { lat: <%= post.lat %>, lng: <%= post.lng %> }; // 緯度経度のデータ作成
        let marker = new google.maps.Marker({
          position: markerLatLng,
          map: map
        });
  //マーカーをクリックしたとき、詳細情報を表示
        let infowindow = new google.maps.InfoWindow({
          position: markerLatLng,
          content: "<a href='<%= post_url(post.id) %>' target='_blank'><%= post.body %></a>"
        }); //ここで詳細ページへのリンクを表示させる
        marker.addListener('click', function() {
          infowindow.open(map, marker);
        });

     })();
    <% end %>
    //複数マーカー ここまで
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBadobo2NJ9FUPJOJukDECqY4aqfxIlKjY&callback=initMap" async defer></script>
<%= paginate @posts %>
